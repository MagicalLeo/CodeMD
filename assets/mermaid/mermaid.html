<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <style>
    html, body { margin:0; padding:0; overflow:hidden; background: transparent; }
  </style>
  <script>
    (function loadMermaid() {
      const localScript = document.createElement('script');
      // Use older mermaid for stability on WebView; adjust if you ship a different version.
      localScript.src = 'mermaid.min.js';
      localScript.onload = () => window.__mermaidReady = true;
      localScript.onerror = () => {
        const cdn = document.createElement('script');
        cdn.src = 'https://cdn.jsdelivr.net/npm/mermaid@9.4.3/dist/mermaid.min.js';
        cdn.onload = () => window.__mermaidReady = true;
        cdn.onerror = () => sendToFlutter({ type: 'renderError', requestId: 'init', error: 'Mermaid JS load failed' });
        document.head.appendChild(cdn);
      };
      document.head.appendChild(localScript);
    })();

    window.onerror = function(message, source, lineno, colno, error) {
      sendToFlutter({ type: 'renderError', requestId: 'onerror', error: `${message} @ ${source}:${lineno}` });
    };

    function sendToFlutter(data) {
      try {
        if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
          window.flutter_inappwebview.callHandler('MermaidChannel', data);
        } else {
          console.log('MermaidChannel missing', data);
        }
      } catch (e) {
        console.log('postMessage error', e);
      }
    }

    async function waitMermaid() {
      const maxWait = 3000;
      const start = performance.now();
      while (!window.__mermaidReady && performance.now() - start < maxWait) {
        await new Promise((r) => setTimeout(r, 30));
      }
      if (!window.__mermaidReady || !window.mermaid) {
        throw new Error('Mermaid not ready');
      }
    }

    async function renderMermaid(payload) {
      const { code, theme, requestId } = payload;
      try {
        await waitMermaid();
        window.mermaid.initialize({
          startOnLoad: false,
          securityLevel: 'loose',
          theme: theme || 'default',
          flowchart: { htmlLabels: false, useMaxWidth: false },
          sequence: { useMaxWidth: false, mirrorActors: false, useHtmlLabels: false },
          class: { useMaxWidth: false, htmlLabels: false },
          er: { useMaxWidth: false, htmlLabels: false },
          journey: { useHtmlLabels: false },
          pie: { useHtmlLabels: false },
        });
        window.mermaid.render(`id${Date.now()}`, code, async (svgCode) => {
          const svgBase64 = btoa(unescape(encodeURIComponent(svgCode)));
          try {
            const pngBase64 = await svgToPng(svgCode);
            sendToFlutter({ type: 'renderSuccess', requestId, svg: svgBase64, png: pngBase64 });
          } catch (e) {
            sendToFlutter({ type: 'renderSuccess', requestId, svg: svgBase64 });
          }
        });
      } catch (e) {
        sendToFlutter({ type: 'renderError', requestId, error: e.message || String(e) });
      }
    }

    async function svgToPng(svgString) {
      return new Promise((resolve, reject) => {
        const svgBlob = new Blob([svgString], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(svgBlob);
        const img = new Image();
        img.onload = () => {
          try {
            const canvas = document.createElement('canvas');
            const ratio = 2.5; // hi-dpi
            canvas.width = img.width * ratio;
            canvas.height = img.height * ratio;
            const ctx = canvas.getContext('2d');
            ctx.scale(ratio, ratio);
            ctx.drawImage(img, 0, 0);
            const dataUrl = canvas.toDataURL('image/png');
            URL.revokeObjectURL(url);
            resolve(dataUrl.split(',')[1]); // strip data prefix
          } catch (err) {
            reject(err);
          }
        };
        img.onerror = reject;
        img.src = url;
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.renderMermaid = renderMermaid;
      sendToFlutter({ type: 'ready' });
    });
  </script>
</head>
<body></body>
</html>
